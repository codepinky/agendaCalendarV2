---
- name: Create backend directory structure
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0755'
  loop:
    - "{{ backend_dir }}"
    - "{{ backend_dir }}/logs"
  tags: [backend, deploy]

- name: Install rsync (if not installed)
  dnf:
    name: rsync
    state: present
  when: ansible_facts['distribution'] == "Amazon"
  ignore_errors: yes
  tags: [backend]

- name: Install rsync (Oracle Linux)
  yum:
    name: rsync
    state: present
  when: ansible_facts['distribution'] != "Amazon"
  ignore_errors: yes
  tags: [backend]

- name: Copy backend files from local machine
  synchronize:
    src: "{{ backend_src_dir | default(playbook_dir ~ '/../../backend/') }}"
    dest: "{{ backend_dir }}/"
    delete: yes
    rsync_opts:
      - "--exclude=node_modules"
      - "--exclude=.env"
      - "--exclude=dist"
      - "--exclude=.git"
      - "--exclude=*.log"
  delegate_to: localhost
  become: no
  tags: [backend, deploy]

- name: Check if .env file exists and has real values
  stat:
    path: "{{ backend_dir }}/.env"
  register: env_file_stat
  tags: [backend]

- name: Check if .env has placeholder values
  shell: |
    if [ -f "{{ backend_dir }}/.env" ]; then
      grep -q "SUA_CHAVE_AQUI\|SEU_FIREBASE_PROJECT_ID\|SEU_FIREBASE_CLIENT_EMAIL" "{{ backend_dir }}/.env" && echo "has_placeholders" || echo "no_placeholders"
    else
      echo "file_not_exists"
    fi
  register: env_file_check
  changed_when: false
  tags: [backend]

- name: Backup existing .env file
  copy:
    src: "{{ backend_dir }}/.env"
    dest: "{{ backend_dir }}/.env.backup"
    remote_src: yes
  when: env_file_stat.stat.exists and env_file_check.stdout == "no_placeholders"
  tags: [backend]

- name: Create backend .env file (only if missing or has placeholders)
  template:
    src: backend.env.j2
    dest: "{{ backend_dir }}/.env"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0600'
  when: not env_file_stat.stat.exists or env_file_check.stdout == "has_placeholders" or env_file_check.stdout == "file_not_exists"
  tags: [backend]

- name: Install backend dependencies
  npm:
    path: "{{ backend_dir }}"
    state: present
  environment:
    npm_config_jobs: "{{ npm_config_jobs | default(omit) }}"
  become_user: "{{ app_user }}"
  tags: [backend, deploy]

- name: Build backend
  command: npm run build
  args:
    chdir: "{{ backend_dir }}"
  environment:
    npm_config_jobs: "{{ npm_config_jobs | default(omit) }}"
    NODE_OPTIONS: "--max-old-space-size={{ node_max_old_space_size_mb | default(1536) }}"
  become_user: "{{ app_user }}"
  tags: [backend, deploy]

- name: Create systemd service file
  template:
    src: agenda-calendar-backend.service.j2
    dest: /etc/systemd/system/agenda-calendar-backend.service
    mode: '0644'
  notify:
    - reload systemd
    - restart backend
  tags: [backend]

- name: Enable and start backend service
  systemd:
    name: agenda-calendar-backend
    enabled: yes
    state: started
  tags: [backend, deploy]

- name: Wait for backend to be ready
  uri:
    url: "http://localhost:3000/health"
    status_code: 200
  register: backend_health
  until: backend_health.status == 200
  retries: 30
  delay: 3
  ignore_errors: yes
  tags: [backend, deploy]

- name: Install nginx (if not installed)
  yum:
    name: nginx
    state: present
  when: ansible_facts['distribution'] != "Amazon"
  ignore_errors: yes
  tags: [backend, nginx]

- name: Install nginx (Amazon Linux)
  dnf:
    name: nginx
    state: present
  when: ansible_facts['distribution'] == "Amazon"
  ignore_errors: yes
  tags: [backend, nginx]

- name: Create nginx configuration
  template:
    src: "{{ playbook_dir }}/templates/nginx-config.j2"
    dest: /etc/nginx/conf.d/agenda-calendar.conf
    mode: '0644'
  notify:
    - reload nginx
  tags: [backend, nginx]

- name: Ensure nginx is enabled and started
  systemd:
    name: nginx
    enabled: yes
    state: started
  tags: [backend, nginx]

- name: Display backend information
  debug:
    msg:
      - "Backend is running on port 3000"
      - "Health check: http://{{ ansible_default_ipv4.address }}:3000/health"
  tags: [backend, deploy]

